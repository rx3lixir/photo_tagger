# Photo Tagger API

ะะฒัะพะผะฐัะธัะตัะบะพะต ััะณะณะธัะพะฒะฐะฝะธะต ัะพัะพะณัะฐัะธะน ั ะฟะพะผะพััั CLIP ะผะพะดะตะปะธ ะธ FastAPI. ะกะธััะตะผะฐ ะฟะพะทะฒะพะปัะตั ะฐะฝะฐะปะธะทะธัะพะฒะฐัั ะธะทะพะฑัะฐะถะตะฝะธั, ะพะฟัะตะดะตะปััั ัะพะดะตัะถะธะผะพะต ะธ ัะพััะฐะฝััั ัะตะทัะปััะฐัั ะฒ PostgreSQL ะฑะฐะทะต ะดะฐะฝะฝัั.

## ๐ ะะพะทะผะพะถะฝะพััะธ

- **ะะฒัะพะผะฐัะธัะตัะบะพะต ััะณะณะธัะพะฒะฐะฝะธะต** ะธะทะพะฑัะฐะถะตะฝะธะน ั ะฟะพะผะพััั CLIP ะผะพะดะตะปะธ
- **ะัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ** ะฑะพะปััะธั ะพะฑัะตะผะพะฒ ัะพัะพะณัะฐัะธะน
- **RESTful API** ั ะดะพะบัะผะตะฝัะฐัะธะตะน Swagger
- **PostgreSQL** ะดะปั ััะฐะฝะตะฝะธั ัะตะทัะปััะฐัะพะฒ
- **Docker** ะดะปั ะฟัะพััะพะณะพ ัะฐะทะฒะตัััะฒะฐะฝะธั ะฑะฐะทั ะดะฐะฝะฝัั
- **ะะทะฒะปะตัะตะฝะธะต EXIF** ะดะฐะฝะฝัั ะธะท ัะพัะพะณัะฐัะธะน
- **ะะฐะบะตัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ** ะดะธัะตะบัะพัะธะน

## ๐ ะขัะตะฑะพะฒะฐะฝะธั

- Python 3.8+
- Docker ะธ Docker Compose
- CUDA (ะพะฟัะธะพะฝะฐะปัะฝะพ, ะดะปั ััะบะพัะตะฝะธั ะฝะฐ GPU)

## ๐ ะฃััะฐะฝะพะฒะบะฐ

### 1. ะะปะพะฝะธัะพะฒะฐะฝะธะต ะธ ัััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน

```bash
git clone <your-repo>
cd photo-tagger
```

```bash
# ะกะพะทะดะฐะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
python -m venv venv
source venv/bin/activate  # Linux/Mac
# ะธะปะธ
venv\Scripts\activate     # Windows

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ
pip install -r requirements.txt
```

### 2. ะะฐะฟััะบ PostgreSQL

```bash
# ะะฐะฟััะบะฐะตะผ ะฑะฐะทั ะดะฐะฝะฝัั ะฒ Docker
docker-compose up -d

# ะัะพะฒะตััะตะผ ััะพ ะบะพะฝัะตะนะฝะตั ะทะฐะฟัััะธะปัั
docker-compose ps
```

ะะฐะทะฐ ะดะฐะฝะฝัั ะฑัะดะตั ะดะพัััะฟะฝะฐ ะฝะฐ `localhost:5432` ั ะฟะฐัะฐะผะตััะฐะผะธ:
- **ะะฐะทะฐ:** `photo_archive`
- **ะะพะปัะทะพะฒะฐัะตะปั:** `postgres`
- **ะะฐัะพะปั:** `postgres`

### 3. ะะฐะฟััะบ API

```bash
# ะัะพััะพะน ะทะฐะฟััะบ
python run.py

# ะะปะธ ัะตัะตะท uvicorn ะฝะฐะฟััะผัั
uvicorn api:app --host 0.0.0.0 --port 8000 --reload
```

API ะฑัะดะตั ะดะพัััะฟะฝะพ ะฟะพ ะฐะดัะตัั: http://localhost:8000

## ๐ ะัะฟะพะปัะทะพะฒะฐะฝะธะต

### Swagger UI

ะัะบัะพะนัะต http://localhost:8000/docs ะดะปั ะธะฝัะตัะฐะบัะธะฒะฝะพะน ะดะพะบัะผะตะฝัะฐัะธะธ API.

### ะัะฝะพะฒะฝัะต ัะฝะดะฟะพะธะฝัั

#### 1. ะขัะณะณะธัะพะฒะฐะฝะธะต ะพะดะฝะพะณะพ ะธะทะพะฑัะฐะถะตะฝะธั

```bash
curl -X POST "http://localhost:8000/tag/image" \
  -H "Content-Type: application/json" \
  -d '{
    "image_path": "/path/to/your/image.jpg",
    "tags": ["cat", "dog", "landscape", "city", "food", "beach", "party"],
    "top_k": 4
  }'
```

**ะัะฒะตั (ัะพะปัะบะพ ัะพะฟ-4 ััะณะฐ):**
```json
{
  "image_path": "/path/to/your/image.jpg",
  "tags": [
    ["landscape", 0.8945],
    ["city", 0.1234],
    ["beach", 0.0876],
    ["cat", 0.0543]
  ],
  "exif_datetime": "2024:05:15 14:30:22",
  "error": null
}
```

#### 2. ะขัะณะณะธัะพะฒะฐะฝะธะต ะดะธัะตะบัะพัะธะธ

```bash
curl -X POST "http://localhost:8000/tag/directory" \
  -H "Content-Type: application/json" \
  -d '{
    "directory_path": "/path/to/photos/",
    "tags": ["cat", "dog", "landscape", "party", "food", "beach", "city"],
    "file_extensions": [".jpg", ".jpeg", ".png"],
    "top_k": 4
  }'
```

**ะัะฒะตั:**
```json
{
  "message": "ะะฐะฟััะตะฝะฐ ะพะฑัะฐะฑะพัะบะฐ 150 ะธะทะพะฑัะฐะถะตะฝะธะน",
  "directory": "/path/to/photos/",
  "files_count": 150
}
```

#### 3. ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั API

```bash
curl http://localhost:8000/health
```

### Python ะฟัะธะผะตั

```python
import requests

# ะขัะณะณะธัะพะฒะฐะฝะธะต ะพะดะฝะพะณะพ ะธะทะพะฑัะฐะถะตะฝะธั
response = requests.post(
    "http://localhost:8000/tag/image",
    json={
        "image_path": "./images/my_photo.jpg",
        "tags": ["cat", "dog", "landscape", "city", "food", "beach", "party"],
        "top_k": 4  # ะะพะปััะธะผ ัะพะปัะบะพ 4 ะปัััะธั ััะณะฐ
    }
)

result = response.json()
print(f"ะัััะธะน ััะณ: {result['tags'][0][0]} ({result['tags'][0][1]:.3f})")
print(f"ะัะตะณะพ ะฝะฐะนะดะตะฝะพ: {len(result['tags'])} ััะณะพะฒ")
```

## ๐ฏ ะะฐัะฐะผะตััั ััะณะณะธัะพะฒะฐะฝะธั

### ะขัะณะธ ะฟะพ ัะผะพะปัะฐะฝะธั

ะัะปะธ ะฝะต ัะบะฐะทะฐัั ัะฒะพะธ ััะณะธ, ะธัะฟะพะปัะทััััั ัะปะตะดัััะธะต:

```python
DEFAULT_TAGS = [
    "cat", "dog", "car", "landscape", "party",
    "food", "beach", "city", "children", "sport",
    "Victory Day", "veterans", "celebration", "military"
]
```

### ะะฐัะฐะผะตัั top_k

- **ะะพ ัะผะพะปัะฐะฝะธั:** `top_k = 4` (ะฒะพะทะฒัะฐัะฐัััั ัะพะปัะบะพ 4 ะปัััะธั ััะณะฐ)
- **ะะพะถะฝะพ ะธะทะผะตะฝะธัั:** ะพั 1 ะดะพ ะบะพะปะธัะตััะฒะฐ ะฟะตัะตะดะฐะฝะฝัั ััะณะพะฒ
- **ะ ะฑะฐะทะต ัะพััะฐะฝััััั:** ัะพะปัะบะพ ะฒัะฑัะฐะฝะฝัะต ัะพะฟ-K ััะณะพะฒ

## ๐ ะะฐะทะฐ ะดะฐะฝะฝัั

### ะกัััะบัััะฐ ัะฐะฑะปะธัั `tagged_images`

| ะะพะปะพะฝะบะฐ | ะขะธะฟ | ะะฟะธัะฐะฝะธะต |
|---------|-----|----------|
| `id` | SERIAL | ะฃะฝะธะบะฐะปัะฝัะน ID |
| `image_path` | VARCHAR(1000) | ะััั ะบ ะธะทะพะฑัะฐะถะตะฝะธั |
| `tags` | JSONB | ะขัะณะธ ั ะฒะตัะพััะฝะพัััะผะธ |
| `exif_datetime` | TIMESTAMP | ะะฐัะฐ ะธะท EXIF |
| `created_at` | TIMESTAMP | ะัะตะผั ะฟะตัะฒะพะน ะพะฑัะฐะฑะพัะบะธ |
| `updated_at` | TIMESTAMP | ะัะตะผั ะฟะพัะปะตะดะฝะตะณะพ ะพะฑะฝะพะฒะปะตะฝะธั |

### ะัะธะผะตั ะทะฐะฟัะพัะฐ ะบ ะะ

```sql
-- ะะพะธัะบ ะฒัะตั ัะพัะพะณัะฐัะธะน ั ะบะพัะฐะผะธ
SELECT image_path, tags->>0 as best_tag 
FROM tagged_images 
WHERE tags @> '[{"tag": "cat"}]'::jsonb;

-- ะกัะฐัะธััะธะบะฐ ะฟะพ ััะณะฐะผ
SELECT 
  jsonb_array_elements(tags)->>'tag' as tag,
  COUNT(*) as count
FROM tagged_images 
GROUP BY tag 
ORDER BY count DESC;
```

## โ๏ธ ะะพะฝัะธะณััะฐัะธั

### ะะฐัะฐะผะตััั ะฑะฐะทั ะดะฐะฝะฝัั

ะะทะผะตะฝะธัะต ะฒ `database.py`:

```python
self.db_config = {
    'host': 'localhost',      # ะฅะพัั PostgreSQL
    'port': 5432,            # ะะพัั
    'user': 'postgres',      # ะะพะปัะทะพะฒะฐัะตะปั
    'password': 'postgres',  # ะะฐัะพะปั
    'database': 'photo_archive'  # ะะผั ะฑะฐะทั
}
```

### ะะฐัััะพะนะบะฐ ะผะพะดะตะปะธ CLIP

ะ `tagger.py` ะผะพะถะฝะพ ะธะทะผะตะฝะธัั ะผะพะดะตะปั:

```python
# ะะพัััะฟะฝัะต ะผะพะดะตะปะธ: ViT-B-32, ViT-B-16, ViT-L-14
model, _, preprocess = open_clip.create_model_and_transforms(
    'ViT-L-14',  # ะะพะปะตะต ัะพัะฝะฐั, ะฝะพ ะผะตะดะปะตะฝะฝะฐั ะผะพะดะตะปั
    pretrained='openai',
    device=self.device
)
```

### ะะฐะทะผะตั ะฟะฐะบะตัะฐ ะพะฑัะฐะฑะพัะบะธ

ะ `api.py` ะฝะฐัััะพะนัะต ัะฐะทะผะตั ะฟะฐะบะตัะฐ:

```python
batch_size = 10  # ะฃะผะตะฝััะธัะต ะดะปั ัะปะฐะฑัั ะผะฐัะธะฝ, ัะฒะตะปะธัััะต ะดะปั ะผะพัะฝัั
```

## ๐ง Troubleshooting

### ะัะพะฑะปะตะผะฐ: "CUDA out of memory"

```python
# ะ tagger.py ะธะทะผะตะฝะธัะต ะฝะฐ CPU
tagger = CLIPTagger(device="cpu")
```

### ะัะพะฑะปะตะผะฐ: ะะตะดะปะตะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ

1. **ะัะฟะพะปัะทัะนัะต GPU:** ะฃััะฐะฝะพะฒะธัะต CUDA ะธ PyTorch ั GPU ะฟะพะดะดะตัะถะบะพะน
2. **ะฃะฒะตะปะธัััะต batch_size:** ะ `api.py` ัะฒะตะปะธัััะต ะดะพ 20-50
3. **ะัะฟะพะปัะทัะนัะต ะผะตะฝัััั ะผะพะดะตะปั:** ViT-B-32 ะฒะผะตััะพ ViT-L-14

### ะัะพะฑะปะตะผะฐ: "Connection refused" ะบ PostgreSQL

```bash
# ะัะพะฒะตัััะต ััะฐััั ะบะพะฝัะตะนะฝะตัะฐ
docker-compose ps

# ะะตัะตะทะฐะฟัััะธัะต ะฑะฐะทั ะดะฐะฝะฝัั
docker-compose down
docker-compose up -d

# ะัะพะฒะตัััะต ะปะพะณะธ
docker-compose logs postgres
```

### ะัะพะฑะปะตะผะฐ: ะะพะปััะธะต ะธะทะพะฑัะฐะถะตะฝะธั

ะะพะฑะฐะฒััะต ัะตัะฐะนะท ะฒ `image_utils.py`:

```python
def load_image(image_path: str) -> Image.Image:
    img = Image.open(image_path)
    # ะะตัะฐะนะท ะฑะพะปััะธั ะธะทะพะฑัะฐะถะตะฝะธะน
    if img.size[0] > 2048 or img.size[1] > 2048:
        img.thumbnail((2048, 2048), Image.Resampling.LANCZOS)
    return img
```

## ๐ ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

### ะขะตััะพะฒัะต ัะตะทัะปััะฐัั

| ะะพะฝัะธะณััะฐัะธั | ะะทะพะฑัะฐะถะตะฝะธะน/ัะตะบ | ะัะธะผะตัะฐะฝะธะต |
|--------------|-----------------|------------|
| CPU (Intel i7) | ~2-3 | ะะตะดะปะตะฝะฝะพ |
| GPU (RTX 3060) | ~15-20 | ะะตะบะพะผะตะฝะดัะตััั |
| GPU (RTX 4090) | ~40-50 | ะััััะพ |

### ะะฟัะธะผะธะทะฐัะธั

1. **GPU ะพะฑัะทะฐัะตะปัะฝะพ** ะดะปั ะฑะพะปััะธั ะพะฑัะตะผะพะฒ
2. **Batch ะพะฑัะฐะฑะพัะบะฐ** - ะฝะต ะพัะฟัะฐะฒะปัะนัะต ะธะทะพะฑัะฐะถะตะฝะธั ะฟะพ ะพะดะฝะพะผั
3. **SSD ะดะธัะบ** ะดะปั ะฑััััะพะณะพ ััะตะฝะธั ะธะทะพะฑัะฐะถะตะฝะธะน
4. **ะะพััะฐัะพัะฝะพ RAM** - ะผะพะดะตะปั ะทะฐะฝะธะผะฐะตั ~2-4 ะะ

## ๐ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   FastAPI       โ    โ   CLIPTagger     โ    โ   PostgreSQL    โ
โ                 โ    โ                  โ    โ                 โ
โ โข HTTP Routes   โโโโโถโ โข Image Loading  โ    โ โข Tagged Images โ
โ โข Async Tasks   โ    โ โข CLIP Model     โ    โ โข EXIF Data     โ
โ โข Background    โ    โ โข Tag Inference  โ    โ โข Search Index  โ
โ   Processing    โ    โ                  โ    โ                 โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
         โ                        โ                        โฒ
         โ                        โ                        โ
         โโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโ
                                  โ
                            โโโโโโโผโโโโโโโ
                            โ File Systemโ
                            โ   Images   โ
                            โโโโโโโโโโโโโโ
```

## ๐ TODO / Roadmap

- [ ] **Web ะธะฝัะตััะตะนั** ะดะปั ะทะฐะณััะทะบะธ ะธะทะพะฑัะฐะถะตะฝะธะน
- [ ] **ะะพะธัะบ ะฟะพ ััะณะฐะผ** ัะตัะตะท API
- [ ] **ะกัะฐัะธััะธะบะฐ ะธ ะฐะฝะฐะปะธัะธะบะฐ** 
- [ ] **ะะตะดัะฟะปะธะบะฐัะธั** ะฟะพัะพะถะธั ะธะทะพะฑัะฐะถะตะฝะธะน
- [ ] **ะะพะปัะทะพะฒะฐัะตะปััะบะธะต ะผะพะดะตะปะธ** CLIP
- [ ] **ะััะธัะพะฒะฐะฝะธะต** ัะตะทัะปััะฐัะพะฒ
- [ ] **ะะพะฝะธัะพัะธะฝะณ** ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

## ๐ ะะธัะตะฝะทะธั

MIT License - ะธัะฟะพะปัะทัะนัะต ะบะฐะบ ัะพัะธัะต!

## ๐ค ะะพะดะดะตัะถะบะฐ

ะัะปะธ ััะพ-ัะพ ะฝะต ัะฐะฑะพัะฐะตั:

1. ะัะพะฒะตัััะต ะปะพะณะธ: `docker-compose logs` ะธ ะปะพะณะธ API
2. ะฃะฑะตะดะธัะตัั ััะพ ะฒัะต ะทะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั
3. ะัะพะฒะตัััะต ัะฒะพะฑะพะดะฝะพะต ะผะตััะพ ะฝะฐ ะดะธัะบะต (ะฑะฐะทะฐ ะดะฐะฝะฝัั ัะฐััะตั)
4. ะะปั GPU ะฟัะพะฑะปะตะผ - ะฟัะพะฒะตัััะต CUDA drivers

---

**ะะพัะพะฒะพ ะบ ะฟัะพะดะฐะบัะตะฝั?** ะะพะฑะฐะฒััะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั, HTTPS, ะผะพะฝะธัะพัะธะฝะณ ะธ ะฑัะบะฐะฟั! ๐
